<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgentInvoice Dashboard - Arc Testnet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-800 mb-2">‚ö° AgentInvoice Dashboard</h1>
            <p class="text-gray-600 mb-4">Auditable billing for AI agents on Arc Testnet</p>
            <div class="flex items-center gap-2 text-sm">
                <span class="px-3 py-1 bg-green-100 text-green-800 rounded-full font-medium">
                    ‚úÖ Connected to Arc Testnet
                </span>
                <span class="text-gray-500">Registry: <code class="text-xs bg-gray-100 px-2 py-1 rounded">0x34158fedf9f863cfdf7da54b3baf7b2ae700b70c</code></span>
            </div>
        </div>

        <!-- Stats -->
        <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-lg shadow p-6">
                <div class="text-gray-500 text-sm mb-1">Total Invoices</div>
                <div class="text-3xl font-bold text-gray-800" id="totalInvoices">-</div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="text-gray-500 text-sm mb-1">Pending</div>
                <div class="text-3xl font-bold text-yellow-600" id="pendingCount">-</div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="text-gray-500 text-sm mb-1">Paid</div>
                <div class="text-3xl font-bold text-green-600" id="paidCount">-</div>
            </div>
            <div class="bg-white rounded-lg shadow p-6">
                <div class="text-gray-500 text-sm mb-1">Held</div>
                <div class="text-3xl font-bold text-red-600" id="heldCount">-</div>
            </div>
        </div>

        <!-- Invoices List -->
        <div class="bg-white rounded-lg shadow-lg p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">Recent Invoices</h2>
                <button onclick="loadInvoices()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition">
                    üîÑ Refresh
                </button>
            </div>
            <div id="invoicesList" class="space-y-4">
                <div class="text-center text-gray-500 py-8">Loading invoices...</div>
            </div>
        </div>

        <!-- Contract Info -->
        <div class="bg-white rounded-lg shadow-lg p-6 mt-6">
            <h3 class="text-lg font-bold text-gray-800 mb-4">üìù Contract Information</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                <div><span class="font-semibold">Network:</span> Arc Testnet</div>
                <div><span class="font-semibold">Chain ID:</span> 5042002</div>
                <div><span class="font-semibold">InvoiceRegistry:</span> <code class="text-xs bg-gray-100 px-2 py-1 rounded">0x3415...0b70c</code></div>
                <div><span class="font-semibold">PolicyManager:</span> <code class="text-xs bg-gray-100 px-2 py-1 rounded">0x11df...9886</code></div>
                <div><span class="font-semibold">PaymentProcessor:</span> <code class="text-xs bg-gray-100 px-2 py-1 rounded">0x3e41...b864</code></div>
                <div><span class="font-semibold">Circle Wallet:</span> <code class="text-xs bg-gray-100 px-2 py-1 rounded">0x264d...3f87</code></div>
            </div>
        </div>

        <div class="text-center mt-6 text-gray-600 text-sm">
            Built for Agentic Commerce on Arc Hackathon üöÄ<br>
            Powered by Circle ‚Ä¢ Deployed via Circle Console
        </div>
    </div>

    <script>
        const RPC_URL = 'https://rpc.testnet.arc.network';
        const REGISTRY_ADDRESS = '0x34158fedf9f863cfdf7da54b3baf7b2ae700b70c';
        
        const REGISTRY_ABI = [
            "function getInvoicesByPayer(address _payer) view returns (bytes32[])",
            "function getInvoice(bytes32 _invoiceId) view returns (tuple(bytes32 id, address payer, address payee, uint256 amount, string description, uint8 status, uint256 createdAt, uint256 paidAt, bytes32 usageHash, bytes usageSignature))"
        ];

        let provider;
        let registry;

        async function init() {
            try {
                console.log('Initializing with ethers:', typeof ethers);
                provider = new ethers.providers.JsonRpcProvider(RPC_URL);
                registry = new ethers.Contract(REGISTRY_ADDRESS, REGISTRY_ABI, provider);
                console.log('Registry initialized:', registry.address);
                await loadInvoices();
            } catch (error) {
                console.error('Init error:', error);
                document.getElementById('invoicesList').innerHTML = `
                    <div class="text-center text-red-600 py-8">
                        ‚ùå Initialization error: ${error.message}
                    </div>
                `;
            }
        }

        function formatDate(timestamp) {
            if (!timestamp || timestamp == 0) return '-';
            const date = new Date(timestamp * 1000);
            return date.toLocaleDateString('en-GB', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            }).split('/').reverse().join('/'); // DD/MM/YYYY to YYYY/MM/DD
        }

        function formatDateTime(timestamp) {
            if (!timestamp || timestamp == 0) return '-';
            const date = new Date(timestamp * 1000);
            const dateStr = date.toLocaleDateString('en-GB', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
            const timeStr = date.toLocaleTimeString('en-GB', {
                hour: '2-digit',
                minute: '2-digit'
            });
            return `${dateStr} ${timeStr}`;
        }

        function toggleDetails(invoiceId) {
            const details = document.getElementById(`details-${invoiceId}`);
            const arrow = document.getElementById(`arrow-${invoiceId}`);
            if (details.classList.contains('hidden')) {
                details.classList.remove('hidden');
                arrow.textContent = '‚ñº';
            } else {
                details.classList.add('hidden');
                arrow.textContent = '‚ñ∂';
            }
        }

        async function loadInvoices() {
            try {
                const walletAddress = '0x264d02e95d182427db11a111d7b3d256d16f3f87';
                console.log('Loading invoices for:', walletAddress);
                
                const invoiceIds = await registry.getInvoicesByPayer(walletAddress);
                console.log('Invoice IDs:', invoiceIds);
                
                let pending = 0, paid = 0, held = 0;
                const invoices = [];

                for (const id of invoiceIds) {
                    const invoice = await registry.getInvoice(id);
                    const statusNum = invoice.status;
                    if (statusNum === 0) pending++;
                    else if (statusNum === 1) paid++;
                    else if (statusNum === 3) held++;
                    
                    invoices.push({
                        id: id,
                        payer: invoice.payer,
                        payee: invoice.payee,
                        amount: ethers.utils.formatUnits(invoice.amount, 6),
                        description: invoice.description,
                        status: statusNum,
                        createdAt: invoice.createdAt.toNumber(),
                        paidAt: invoice.paidAt.toNumber(),
                        usageHash: invoice.usageHash
                    });
                }

                document.getElementById('totalInvoices').textContent = invoices.length;
                document.getElementById('pendingCount').textContent = pending;
                document.getElementById('paidCount').textContent = paid;
                document.getElementById('heldCount').textContent = held;

                renderInvoices(invoices);
            } catch (error) {
                console.error('Error loading invoices:', error);
                document.getElementById('invoicesList').innerHTML = `
                    <div class="text-center text-red-600 py-8">
                        ‚ùå Error loading invoices: ${error.message}
                    </div>
                `;
            }
        }

        function renderInvoices(invoices) {
            const statusLabels = ['PENDING', 'PAID', 'CANCELLED', 'HELD'];
            const statusColors = {
                0: 'bg-yellow-100 text-yellow-800',
                1: 'bg-green-100 text-green-800',
                2: 'bg-gray-100 text-gray-800',
                3: 'bg-red-100 text-red-800'
            };

            const html = invoices.map(inv => {
                const shortId = inv.id.slice(0, 20) + '...';
                return `
                    <div class="border rounded-lg p-4 hover:shadow-md transition cursor-pointer" onclick="toggleDetails('${inv.id}')">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="text-xs font-mono text-gray-500">Invoice ID</span>
                                    <code class="text-xs bg-gray-100 px-2 py-1 rounded">${shortId}</code>
                                    <span class="px-2 py-1 rounded-full text-xs font-semibold ${statusColors[inv.status]}">
                                        ${statusLabels[inv.status]}
                                    </span>
                                    <span id="arrow-${inv.id}" class="text-gray-400 text-xs">‚ñ∂</span>
                                </div>
                                <div class="grid grid-cols-2 gap-4 text-sm">
                                    <div>
                                        <span class="text-gray-500">Amount</span>
                                        <div class="font-semibold">${inv.amount} USDC</div>
                                    </div>
                                    <div>
                                        <span class="text-gray-500">Created</span>
                                        <div class="font-semibold">${formatDate(inv.createdAt)}</div>
                                    </div>
                                </div>
                                <div class="mt-2 text-gray-700">${inv.description}</div>
                            </div>
                        </div>
                        
                        <!-- Expandable Details -->
                        <div id="details-${inv.id}" class="hidden mt-4 pt-4 border-t">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                <div>
                                    <div class="text-gray-500 mb-1">Payer</div>
                                    <a href="https://testnet.arcscan.com/address/${inv.payer}" target="_blank" 
                                       class="text-blue-600 hover:underline font-mono text-xs break-all">
                                        ${inv.payer}
                                    </a>
                                </div>
                                <div>
                                    <div class="text-gray-500 mb-1">Payee</div>
                                    <a href="https://testnet.arcscan.com/address/${inv.payee}" target="_blank" 
                                       class="text-blue-600 hover:underline font-mono text-xs break-all">
                                        ${inv.payee}
                                    </a>
                                </div>
                                <div>
                                    <div class="text-gray-500 mb-1">Created At</div>
                                    <div class="font-semibold">${formatDateTime(inv.createdAt)}</div>
                                </div>
                                <div>
                                    <div class="text-gray-500 mb-1">Paid At</div>
                                    <div class="font-semibold">${inv.paidAt ? formatDateTime(inv.paidAt) : 'Not paid yet'}</div>
                                </div>
                                <div class="md:col-span-2">
                                    <div class="text-gray-500 mb-1">Full Invoice ID</div>
                                    <code class="text-xs bg-gray-100 px-2 py-1 rounded block break-all">${inv.id}</code>
                                </div>
                                <div class="md:col-span-2">
                                    <div class="text-gray-500 mb-1">Usage Attestation Hash</div>
                                    <code class="text-xs bg-gray-100 px-2 py-1 rounded block break-all">${inv.usageHash}</code>
                                </div>
                                <div class="md:col-span-2">
                                    <a href="https://testnet.arcscan.com/address/${REGISTRY_ADDRESS}" target="_blank"
                                       class="inline-block px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition">
                                        üîó View on Arc Explorer
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('invoicesList').innerHTML = html || '<div class="text-center text-gray-500 py-8">No invoices found</div>';
        }

        // Initialize when page loads
        window.addEventListener('load', init);
    </script>
</body>
</html>
