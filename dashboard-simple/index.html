<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgentInvoice Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
</head>
<body class="bg-gray-50">
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow">
            <div class="max-w-7xl mx-auto py-6 px-4">
                <h1 class="text-3xl font-bold text-gray-900">
                    ‚ö° AgentInvoice Dashboard
                </h1>
                <p class="text-gray-600">Auditable billing for AI agents on Arc Testnet</p>
            </div>
        </header>

        <!-- Main Content -->
        <main class="max-w-7xl mx-auto py-6 px-4">
            <!-- Connection Status -->
            <div id="connection-status" class="mb-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                <p class="text-blue-800">üîÑ Connecting to Arc Testnet...</p>
            </div>

            <!-- Stats Cards -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-gray-500 text-sm font-medium">Total Invoices</h3>
                    <p id="total-invoices" class="text-3xl font-bold text-gray-900">-</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-gray-500 text-sm font-medium">Pending</h3>
                    <p id="pending-invoices" class="text-3xl font-bold text-yellow-600">-</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-gray-500 text-sm font-medium">Paid</h3>
                    <p id="paid-invoices" class="text-3xl font-bold text-green-600">-</p>
                </div>
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-gray-500 text-sm font-medium">Held</h3>
                    <p id="held-invoices" class="text-3xl font-bold text-red-600">-</p>
                </div>
            </div>

            <!-- Invoice List -->
            <div class="bg-white shadow rounded-lg">
                <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                    <h2 class="text-xl font-semibold text-gray-900">Recent Invoices</h2>
                    <button onclick="loadInvoices()" class="text-sm text-blue-600 hover:text-blue-800">
                        üîÑ Refresh
                    </button>
                </div>
                <div id="invoice-list" class="p-6">
                    <p class="text-gray-500">Loading invoices...</p>
                </div>
            </div>

            <!-- Contract Info -->
            <div class="mt-8 bg-white shadow rounded-lg p-6">
                <h3 class="text-lg font-semibold text-gray-900 mb-4">üìù Contract Information</h3>
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Network:</span>
                        <span class="font-mono text-gray-900">Arc Testnet</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Chain ID:</span>
                        <span class="font-mono text-gray-900">5042002</span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">InvoiceRegistry:</span>
                        <a href="https://testnet.arcscan.io/address/0x34158fedf9f863cfdf7da54b3baf7b2ae700b70c"
                           target="_blank"
                           class="font-mono text-blue-600 hover:text-blue-800 text-xs">
                            0x3415...0b70c
                        </a>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">PolicyManager:</span>
                        <a href="https://testnet.arcscan.io/address/0x11dfb74caad23c1c8884646969d33a990b339886"
                           target="_blank"
                           class="font-mono text-blue-600 hover:text-blue-800 text-xs">
                            0x11df...9886
                        </a>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">PaymentProcessor:</span>
                        <a href="https://testnet.arcscan.io/address/0x3e412244e13701516a3a364278e4f43ba036b864"
                           target="_blank"
                           class="font-mono text-blue-600 hover:text-blue-800 text-xs">
                            0x3e41...b864
                        </a>
                    </div>
                    <div class="flex justify-between pt-2 border-t">
                        <span class="text-gray-600">Circle Wallet:</span>
                        <a href="https://testnet.arcscan.io/address/0x264d02e95d182427db11a111d7b3d256d16f3f87"
                           target="_blank"
                           class="font-mono text-blue-600 hover:text-blue-800 text-xs">
                            0x264d...3f87
                        </a>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="max-w-7xl mx-auto py-6 px-4 mt-12 border-t border-gray-200">
            <p class="text-center text-gray-500 text-sm">
                Built for <strong>Agentic Commerce on Arc</strong> Hackathon üöÄ
                <br>
                <span class="text-xs">Powered by Circle ‚Ä¢ Deployed via Circle Console</span>
            </p>
        </footer>
    </div>

    <script>
        const REGISTRY_ADDRESS = '0x34158fedf9f863cfdf7da54b3baf7b2ae700b70c';
        const RPC_URL = 'https://rpc.testnet.arc.network';
        const CIRCLE_WALLET = '0x264d02e95d182427db11a111d7b3d256d16f3f87';

        const REGISTRY_ABI = [
          "function getInvoicesByPayer(address) view returns (bytes32[])",
          "function getInvoice(bytes32) view returns (tuple(bytes32 id, address payer, address payee, uint256 amount, uint8 status, string description, bytes32 usageHash, bytes usageSignature, uint256 createdAt, uint256 paidAt, string holdReason))"
        ];

        let provider, contract;

        function toggleDetails(invoiceId) {
          const details = document.getElementById(`details-${invoiceId}`);
          const arrow = document.getElementById(`arrow-${invoiceId}`);
          if (details.classList.contains('hidden')) {
            details.classList.remove('hidden');
            arrow.textContent = '‚ñº';
          } else {
            details.classList.add('hidden');
            arrow.textContent = '‚ñ∂';
          }
        }

        async function init() {
          try {
            provider = new ethers.providers.JsonRpcProvider(RPC_URL);
            contract = new ethers.Contract(REGISTRY_ADDRESS, REGISTRY_ABI, provider);

            document.getElementById('connection-status').innerHTML = `
              <p class="text-green-800">‚úÖ Connected to Arc Testnet</p>
              <p class="text-sm text-green-600 mt-1">Registry: ${REGISTRY_ADDRESS}</p>
            `;

            await loadInvoices();
          } catch (error) {
            console.error('Error:', error);
            document.getElementById('connection-status').innerHTML = `
              <p class="text-red-800">‚ùå Connection failed: ${error.message}</p>
            `;
          }
        }

        async function loadInvoices() {
          try {
            const invoiceIds = await contract.getInvoicesByPayer(CIRCLE_WALLET);

            document.getElementById('total-invoices').textContent = invoiceIds.length;

            if (invoiceIds.length === 0) {
              document.getElementById('pending-invoices').textContent = '0';
              document.getElementById('paid-invoices').textContent = '0';
              document.getElementById('held-invoices').textContent = '0';

              document.getElementById('invoice-list').innerHTML = `
                <div class="text-center py-12">
                  <svg class="mx-auto h-16 w-16 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                  </svg>
                  <h3 class="mt-4 text-lg font-medium text-gray-900">No invoices found</h3>
                  <p class="mt-2 text-sm text-gray-500">Invoices created will appear here automatically.</p>
                  <p class="mt-4 text-xs text-gray-400">Deployed via Circle Console during hackathon ‚ú®</p>
                </div>
              `;
              return;
            }

            const invoices = await Promise.all(
              invoiceIds.map(id => contract.getInvoice(id))
            );

            const statuses = ['PENDING', 'PAID', 'HELD', 'CANCELLED'];
            let pending = 0, paid = 0, held = 0;

            invoices.forEach(inv => {
              if (inv.status === 0) pending++;
              else if (inv.status === 1) paid++;
              else if (inv.status === 2) held++;
            });

            document.getElementById('pending-invoices').textContent = pending;
            document.getElementById('paid-invoices').textContent = paid;
            document.getElementById('held-invoices').textContent = held;

            let html = '<div class="space-y-4">';

            invoices.forEach(invoice => {
              const statusColors = ['text-yellow-600 bg-yellow-50', 'text-green-600 bg-green-50', 'text-red-600 bg-red-50', 'text-gray-600 bg-gray-50'];
              const statusColor = statusColors[invoice.status];

              html += `
                <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition cursor-pointer" onclick="toggleDetails('${invoice.id}')">
                  <div class="flex justify-between items-start mb-3">
                    <div class="flex-1">
                      <div class="flex items-center gap-2">
                        <p class="text-sm font-mono text-gray-500">Invoice ID</p>
                        <p class="text-xs font-mono text-gray-900">${invoice.id.slice(0, 20)}...</p>
                        <span id="arrow-${invoice.id}" class="text-gray-400 text-sm">‚ñ∂</span>
                      </div>
                    </div>
                    <span class="px-3 py-1 rounded-full text-sm font-medium ${statusColor}">
                      ${statuses[invoice.status]}
                    </span>
                  </div>
                  <div class="grid grid-cols-2 gap-4 text-sm">
                    <div>
                      <p class="text-gray-500">Amount</p>
                      <p class="font-semibold">${ethers.utils.formatUnits(invoice.amount, 18)} USDC</p>
                    </div>
                    <div>
                      <p class="text-gray-500">Created</p>
                      <p class="font-semibold">${new Date(invoice.createdAt * 1000).toLocaleDateString()}</p>
                    </div>
                  </div>
                  <p class="mt-3 text-sm text-gray-600">${invoice.description}</p>
                  
                  <!-- Expandable Details Section -->
                  <div id="details-${invoice.id}" class="hidden mt-4 pt-4 border-t border-gray-200">
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-3 mb-4">
                      <p class="text-sm font-semibold text-blue-900 mb-1">üí∞ Payment For:</p>
                      <p class="text-sm text-blue-800">${invoice.description}</p>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                      <div>
                        <p class="text-gray-500 mb-1">üí≥ Paid By (Payer)</p>
                        <a href="https://testnet.arcscan.io/address/${invoice.payer}" target="_blank" class="text-blue-600 hover:underline font-mono text-xs break-all">
                          ${invoice.payer}
                        </a>
                      </div>
                      <div>
                        <p class="text-gray-500 mb-1">üè™ Service Provider (Payee)</p>
                        <a href="https://testnet.arcscan.io/address/${invoice.payee}" target="_blank" class="text-blue-600 hover:underline font-mono text-xs break-all">
                          ${invoice.payee}
                        </a>
                      </div>
                      <div>
                        <p class="text-gray-500 mb-1">üìÖ Invoice Created</p>
                        <p class="font-semibold">${new Date(invoice.createdAt * 1000).toLocaleString()}</p>
                      </div>
                      <div>
                        <p class="text-gray-500 mb-1">‚úÖ Payment Date</p>
                        <p class="font-semibold">${invoice.paidAt > 0 ? new Date(invoice.paidAt * 1000).toLocaleString() : 'Not paid yet'}</p>
                      </div>
                      <div class="md:col-span-2">
                        <p class="text-gray-500 mb-1">üÜî Full Invoice ID</p>
                        <code class="text-xs bg-gray-100 px-2 py-1 rounded block break-all">${invoice.id}</code>
                      </div>
                      <div class="md:col-span-2">
                        <p class="text-gray-500 mb-1">üîê Usage Attestation Hash</p>
                        <code class="text-xs bg-gray-100 px-2 py-1 rounded block break-all">${invoice.usageHash}</code>
                      </div>
                      <div class="md:col-span-2">
                        <a href="https://testnet.arcscan.io/address/${REGISTRY_ADDRESS}" target="_blank" class="inline-block px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 transition text-sm">
                          üîó View Full Details on Arc Explorer
                        </a>
                      </div>
                    </div>
                  </div>
                </div>
              `;
            });

            html += '</div>';
            document.getElementById('invoice-list').innerHTML = html;

          } catch (error) {
            console.error('Error loading invoices:', error);
            document.getElementById('invoice-list').innerHTML = `
              <p class="text-red-600">Error loading invoices: ${error.message}</p>
            `;
          }
        }

        window.addEventListener('load', init);
    </script>
</body>
</html>
